#pragma once
#include "processes.hpp"
#include "string_helper.hpp"
#include <json/json.h>
#include <wx/wx.h>
#include <chrono>
#include <wx/datectrl.h>
#include <wx/dateevt.h>
#include <boost/algorithm/string.hpp>

wxDEFINE_EVENT(wxEVT_REMOVE_BUTTON, wxCommandEvent);

class DataEditWidget : public wxPanel {
	public:
		DataEditWidget(
			wxWindow *parent,
			int id,
			Json::Value &jsonSettings,
			int buttonId,
			int dateCtrlId,
			int deleteButtonId
		)
				: wxPanel(parent, id), _jsonSettings(jsonSettings), _buttonId(buttonId),
					_dateCtrlId(dateCtrlId), _deleteButtonId(deleteButtonId) {
			_file = StringHelper::stringToWideString(_jsonSettings[id]["file"].asString());
			_date = dateFromString(_jsonSettings[id]["date"].asString());

			auto spacerSizer = new wxBoxSizer(wxVERTICAL);
			auto parentSizer = new wxBoxSizer(wxHORIZONTAL);
			auto inputsSizer = new wxBoxSizer(wxVERTICAL);
			auto buttonsSizer = new wxBoxSizer(wxVERTICAL);
			int fileNameCtrlId = id * 13;
			_fileNameCtrl = new wxTextCtrl(this, fileNameCtrlId, _file);
			_dateCtrl = new wxDatePickerCtrl(this, _dateCtrlId, _date);
			_fileDialog = new wxFileDialog(this);
			_fileNameCtrl->Disable();
			inputsSizer->Add(_fileNameCtrl, 2, wxEXPAND, 10);
			inputsSizer->Add(_dateCtrl, 2, wxEXPAND, 10);

			_changeFileButton = new wxButton(this, _buttonId, "Change File");
			_deleteButton = new wxButton(this, _deleteButtonId, "Remove");
			_deleteButton->SetBackgroundColour(wxColour(117, 11, 6));
			_deleteButton->SetForegroundColour(wxColour("WHITE"));

			buttonsSizer->Add(_changeFileButton, 1, wxEXPAND, 10);
			buttonsSizer->Add(_deleteButton, 1, wxEXPAND, 10);

#if WINVER > _WIN32_WINNT_NT4
			parentSizer->Add(inputsSizer, 2, wxEXPAND | wxALIGN_CENTER, 5);
			parentSizer->Add(buttonsSizer, 1, wxEXPAND | wxALIGN_CENTER, 5);
#else
			parentSizer->Add(inputsSizer, 2, wxALIGN_CENTER, 5);
			parentSizer->Add(buttonsSizer, 1, wxALIGN_CENTER, 5);
#endif

			spacerSizer->AddStretchSpacer();
#if WINVER > _WIN32_WINNT_NT4
			spacerSizer->Add(parentSizer, 2, wxEXPAND | wxALIGN_CENTER, 5);
#else
			spacerSizer->Add(parentSizer, 2, wxALIGN_CENTER, 5);
#endif
			SetSizerAndFit(spacerSizer);
			Show();

			Bind(wxEVT_BUTTON, &onFileSelectButtonClick, this, _buttonId);
			Bind(wxEVT_BUTTON, &onRemove, this, _deleteButtonId);
			Bind(wxEVT_TEXT, &onFileChange, this, _fileNameCtrl->GetId());
			Bind(wxEVT_DATE_CHANGED, &onDateChange, this, _dateCtrl->GetId());
		};
		~DataEditWidget();
		void openDialog();

	private:
		int _index;
		int _buttonId;
		int _dateCtrlId;
		int _deleteButtonId;
		std::wstring _file;
		wxDateTime _date;

		Json::Value &_jsonSettings;

		wxTextCtrl *_fileNameCtrl;
		wxDatePickerCtrl *_dateCtrl;
		wxButton *_changeFileButton;
		wxFileDialog *_fileDialog;
		wxButton *_deleteButton;

		void onFileChange(wxCommandEvent &event);
		void onFileSelectButtonClick(wxCommandEvent &event);
		void onRemove(wxCommandEvent &event);
		void onDateChange(wxDateEvent &event);

		wxDateTime dateFromString(std::string input);
};