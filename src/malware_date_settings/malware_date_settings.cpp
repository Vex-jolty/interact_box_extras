#include "malware_date_settings.hpp"

using namespace std;

Json::Value jsonSettings;

string filePath = "C:\\WINDOWS\\malware_with_date_specific_deployment.json";
#if WINVER > _WIN32_WINNT_NT4
string workingDirectory = FileHelper::getWorkingDirectoryAsString();
#else
string workingDirectory = FileHelper::getWorkingDirectory();
#endif
string interactBoxPath = "interact_box.exe";

void saveSettings() {
	FileHelper::writeToFile(filePath, jsonSettings.toStyledString());
}

bool askToSave() {
	int response = wxMessageBox(
		"Some settings were changed, but the changes were not saved. Would you like to save them now?",
		"Malware Date Settings",
		wxICON_WARNING | wxYES_NO
	);
	return response == wxYES;
}

void restartInteractBox() {
	int response = wxMessageBox(
		"In order to apply the settings, Interact Box must be restarted. Would you like to restart it now?",
		"Malware Date Settings",
		wxICON_WARNING | wxYES_NO
	);
	if (response != wxYES) return;
	ProcessHelper::killProcess(interactBoxPath);
	ShellExecuteA(NULL, "open", interactBoxPath.c_str(), NULL, workingDirectory.c_str(), SW_SHOW);
}

void handleError(string errorMessage) {
	wxMessageBox(errorMessage, "MALWARE DATE SETTINGS ERROR", wxICON_ERROR);
}

bool MalwareDateSettings::OnInit() {
	MalwareDateFrame* frame = new MalwareDateFrame();
	SetTopWindow(frame);
	frame->Show(true);
	return true;
}

int MalwareDateSettings::OnExit() {
	return 0;
}

MalwareDateFrame::MalwareDateFrame() : wxFrame(NULL, wxID_ANY, "Malware Date Settings", wxDefaultPosition, wxSize(400, 600)) {
	HICON iconHandle = LoadIcon(GetModuleHandle(NULL), MAKEINTRESOURCE(IDI_ICON1));
	wxIcon icon;
	icon.CreateFromHICON(iconHandle);
	SetIcon(icon);
	DestroyIcon(iconHandle);
	setupParentPanel();

	CreateStatusBar();
	SetStatusText("No changes so far");

	Bind(wxEVT_BUTTON, &OnAddNewMalware, this, ID_ADD);
	Bind(wxEVT_BUTTON, &OnSave, this, ID_SAVE);
	Bind(wxEVT_BUTTON, &OnExit, this, ID_CLOSE);
	Bind(wxEVT_CLOSE_WINDOW, &OnClose, this);
}

void MalwareDateFrame::parseSettings() {
	for (Json::ValueIterator iter = jsonSettings.begin(); iter != jsonSettings.end(); iter++) {
		int index = iter.index();
		tuple<int, int, int> ids = getIds(index);
		int buttonId = get<0>(ids);
		int dateCtrlId = get<1>(ids);
		int deleteButtonId = get<2>(ids);
		auto item = new DataEditWidget(_scrollWindow, index, jsonSettings, buttonId, dateCtrlId, deleteButtonId);
		_scrollSizer->Add(item, 0, wxEXPAND, 5);
		Bind(wxEVT_BUTTON, &OnChange, this, buttonId);
		Bind(wxEVT_BUTTON, &OnDeleted, this, deleteButtonId);
		Bind(wxEVT_DATE_CHANGED, &OnDateChange, this, dateCtrlId);
	}
}

void MalwareDateFrame::OnExit(wxCommandEvent& event) {
	Close(false);
}

void MalwareDateFrame::OnClose(wxCloseEvent& event) {
	event.Veto(true);
	try {
		promptUserIfModified();
	} catch (exception& e) {
		handleError(e.what());
	}
	auto children = _parentPanel->GetChildren();
	for (auto& child : children) {
		child->DestroyChildren();
		child->Destroy();
	}
	_parentPanel->Destroy();
	Destroy();
}

void MalwareDateFrame::OnSave(wxCommandEvent& event) {
	try {
		saveSettings();
	} catch (exception& e) {
		handleError(e.what());
	}
	SetStatusText("Saved!");
	_hasSaved = true;
}

void MalwareDateFrame::OnChange(wxCommandEvent& event) {
	informChange();
}

void MalwareDateFrame::OnDateChange(wxDateEvent& event) {
	informChange();
}

void MalwareDateFrame::promptUserIfModified() {
	if (!_isModified) return;
	if (_hasSaved) {
		restartInteractBox();
		return;
	}
	bool shouldSave = askToSave();
	if (!shouldSave) return;
	saveSettings();
	restartInteractBox();
}

void MalwareDateFrame::setupParentPanel() {
	_parentPanel = new wxPanel(this, wxID_ANY);
	_parentSizer = new wxBoxSizer(wxALL);

	_scrollWindow = new wxScrolledWindow(_parentPanel, wxID_ANY, wxDefaultPosition, wxDefaultSize, wxVSCROLL);
	_scrollWindow->SetScrollRate(5, 10);
	_scrollSizer = new wxBoxSizer(wxVERTICAL);

	try {
		string settingsFile = FileHelper::readFileAsString(filePath);
		jsonSettings = JsonHelper::parseJsonString(settingsFile);
		if (jsonSettings.empty()) {
			throw InteractBoxException(ErrorCodes::CannotReadFile, settingsFile);
		}
	} catch (InteractBoxException& e) {
		handleError(e.what());
		abort();
	}

	parseSettings();
	_scrollWindow->SetSizer(_scrollSizer);
	_scrollWindow->FitInside();

	auto topButtonsSizer = new wxBoxSizer(wxVERTICAL);
	auto topButtonsPanel = new wxPanel(_parentPanel, wxID_ANY);
	auto childButtonsSizer = new wxBoxSizer(wxHORIZONTAL);
	auto childButtonsPanel = new wxPanel(topButtonsPanel, wxID_ANY);

	wxButton* newMalwareButton = new wxButton(topButtonsPanel, ID_ADD, "Add new malware");
	topButtonsSizer->Add(newMalwareButton, 2, wxALL, 3);
	wxButton* saveButton = new wxButton(childButtonsPanel, ID_SAVE, "Save");
	wxButton* closeButton = new wxButton(childButtonsPanel, ID_CLOSE, "Close");
	childButtonsSizer->Add(saveButton, 1, wxALL, 5);
	childButtonsSizer->Add(closeButton, 1, wxALL, 5);
	childButtonsPanel->SetSizerAndFit(childButtonsSizer);
	topButtonsSizer->Add(childButtonsPanel);
	topButtonsPanel->SetSizerAndFit(topButtonsSizer);

	_parentSizer->Add(_scrollWindow, 1, wxEXPAND, 1);
	_parentSizer->Add(topButtonsPanel, 0, wxALIGN_CENTER, 1);

	_parentPanel->SetSizer(_parentSizer);
	_parentSizer->Fit(_parentPanel);
	_parentPanel->Show(true);
}

void MalwareDateFrame::informChange() {
	_isModified = true;
	SetStatusText("Some settings have been changed!");
}

Json::Value MalwareDateFrame::removeFromJsonSettings(int index) {
	Json::Value newValue;
	for (Json::ValueIterator iter = jsonSettings.begin(); iter != jsonSettings.end(); iter++) {
		if (iter.index() == index) continue;
		newValue.append(jsonSettings[iter.index()]);
	}
	return newValue;
}

tuple<int, int, int> MalwareDateFrame::getIds(int index) {
	// Multiplying index by prime numbers to ensure uniqueness
  int buttonId = NewControlId((index + 1) * 17);
	int dateCtrlId = NewControlId((index + 1) * 23);
	int deleteButtonId = NewControlId((index + 1) * 31);
	return make_tuple(buttonId, dateCtrlId, deleteButtonId);
}

void MalwareDateFrame::OnDeleted(wxCommandEvent& event) {
	int id = event.GetInt();
	removeFromJsonSettings(id);
	auto children = _scrollWindow->GetChildren();
	for (auto& child : children) {
		if (child->GetId() != id) continue;
		else {
			child->DestroyChildren();
			child->Destroy();
			break;
		}
	}
	int i = 0;
	for (auto& child : _scrollWindow->GetChildren()) {
		tuple<int, int, int> ids = getIds(i);
		int buttonId = get<0>(ids);
		int dateCtrlId = get<1>(ids);
		int deleteButtonId = get<2>(ids);

		child->SetId(i);
		Bind(wxEVT_BUTTON, &MalwareDateFrame::OnChange, this, buttonId);
		Bind(wxEVT_BUTTON, &MalwareDateFrame::OnDeleted, this, dateCtrlId);
		Bind(wxEVT_DATE_CHANGED, &MalwareDateFrame::OnDateChange, this, deleteButtonId);
		i++;
	}
	_scrollSizer->Layout();
	_scrollWindow->FitInside();
	_scrollWindow->Refresh();
	informChange();
}

void MalwareDateFrame::OnAddNewMalware(wxCommandEvent& event) {
	Json::Value newMalware;
	newMalware["file"] = "";
	newMalware["date"] = "1970-01-01";
	jsonSettings.append(newMalware);
	// Calculate the new IDs based on the size of jsonSettings
	int index = jsonSettings.size() - 1;
	tuple<int, int, int> ids = getIds(index);
	int buttonId = get<0>(ids);
	int dateCtrlId = get<1>(ids);
	int deleteButtonId = get<2>(ids);

	// Create the new DataEditWidget and add it to the sizer
	auto item = new DataEditWidget(_scrollWindow, index, jsonSettings, buttonId, dateCtrlId, deleteButtonId);
	_scrollSizer->Add(item, 0, wxEXPAND, 5);

	// Bind the new buttons to their respective event handlers
	Bind(wxEVT_BUTTON, &MalwareDateFrame::OnChange, this, buttonId);
	Bind(wxEVT_BUTTON, &MalwareDateFrame::OnDeleted, this, deleteButtonId);
	Bind(wxEVT_DATE_CHANGED, &MalwareDateFrame::OnDateChange, this, dateCtrlId);

	// Update the layout and fit the new contents
	_scrollWindow->Layout();
	_scrollWindow->FitInside();
	_scrollWindow->Refresh();
	item->openDialog();

	informChange();
}

wxIMPLEMENT_APP(MalwareDateSettings);