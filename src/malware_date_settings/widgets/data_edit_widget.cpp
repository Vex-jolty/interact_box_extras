#include "malware_date_settings/widgets/data_edit_widget.hpp"

using namespace std;

DataEditWidget::~DataEditWidget() {}

void DataEditWidget::openDialog() {
	auto event = new wxCommandEvent(wxEVT_BUTTON, _buttonId);
	wxQueueEvent(this, event);
}

void DataEditWidget::onFileChange(wxCommandEvent &event) {
	string name = (std::string)event.GetString();
	if (name.ends_with(".inert")) {
		boost::replace_last(name, ".inert", "");
	}
	_jsonSettings[GetId()]["file"] = name;
	event.Skip();
}

void DataEditWidget::onFileSelectButtonClick(wxCommandEvent &event) {
	int result = _fileDialog->ShowModal();
	if (result == wxID_OK) {
#if WINVER > _WIN32_WINNT_NT4
		string path = _fileDialog->GetPath().AfterLast('\\').utf8_string();
#else
		string path = _fileDialog->GetPath().AfterLast('\\').ToStdString();
#endif
		if (path.ends_with(".inert")) {
			boost::replace_last(path, ".inert", "");
		}
		_fileNameCtrl->SetValue(path);
		_jsonSettings[GetId()]["file"] = path;
	}
	event.Skip();
}

void DataEditWidget::onRemove(wxCommandEvent &event) {
	int res = wxMessageBox(
		"Are you sure you want to remove " + _file + "?", "Are you sure?", wxICON_QUESTION | wxYES_NO
	);
	if (res != wxYES)
		return;
	event.SetInt(GetId());
	event.Skip();
}

void DataEditWidget::onDateChange(wxDateEvent &event) {
	_date = event.GetDate();
#if WINVER > _WIN32_WINNT_NT4
	_jsonSettings[GetId()]["date"] = _date.Format("%Y-%m-%d").utf8_string();
#else
	_jsonSettings[GetId()]["date"] = _date.Format("%Y-%m-%d").ToStdString();
#endif
	event.Skip();
}

wxDateTime DataEditWidget::dateFromString(string input) {
	tm timestamp = {};
	stringstream dateStream(input);
	dateStream >> get_time(&timestamp, "%Y-%m-%d");
	return wxDateTime(timestamp);
}
